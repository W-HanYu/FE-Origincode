import{_ as i}from"./reactfiberworkloop-c1dc2d76.js";import{_ as l}from"./fibertree-beforecommit-3829fb16.js";import{_ as u}from"./fibertree-beforecommit-ba9006a9.js";import{_ as r,p as d,q as k,s,R as n,t as a,a2 as t,Y as o,n as c}from"./framework-e1bed10d.js";const m="/FE-Origincode/assets/fiber-effectlist-d1d10c94.png",v="/FE-Origincode/assets/fiber-noredundant-cfe9a1f4.png",f="/FE-Origincode/assets/fiber-switch-9af05a65.png",b="/FE-Origincode/assets/clear-effectlist-0737c81c.png",y={},h=s("h1",{id:"fiber-树渲染",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#fiber-树渲染","aria-hidden":"true"},"#"),n(" fiber 树渲染")],-1),w=s("code",null,"fiber树渲染",-1),E=s("p",null,[s("img",{src:i,alt:""})],-1),g=s("code",null,"react-dom",-1),_=s("code",null,"fiber更新",-1),x=s("code",null,"scheduler",-1),R=s("code",null,"task",-1),C=s("code",null,"fiber树",-1),P=s("code",null,"DOM",-1),W=s("li",null,[n("输出: 与渲染器("),s("code",null,"react-dom"),n(")交互, 渲染"),s("code",null,"DOM"),n("节点.")],-1),D=o('<p>本节分析其中的第 4 阶段(输出), <code>fiber树渲染</code>处于<code>reconciler 运作流程</code>这一流水线的最后一环, 或者说前面的步骤都是为了最后一步服务, 所以其重要性不言而喻.</p><p>前文已经介绍了<code>fiber树构造</code>, 现在分析<code>fiber树渲染</code>过程, 这个过程, 实际上是对<code>fiber树</code>的进一步处理.</p><h2 id="fiber-树特点" tabindex="-1"><a class="header-anchor" href="#fiber-树特点" aria-hidden="true">#</a> fiber 树特点</h2><p>通过前文<code>fiber树构造</code>的解读, 可以总结出<code>fiber树</code>的基本特点:</p><ul><li>无论是<code>首次构造</code>或者是<code>对比更新</code>, 最终都会在内存中生成一棵用于渲染页面的<code>fiber树</code>(即<code>fiberRoot.finishedWork</code>).</li><li>这棵将要被渲染的<code>fiber树</code>有 2 个特点: <ol><li>副作用队列挂载在根节点上(具体来讲是<code>finishedWork.firstEffect</code>)</li><li>代表最新页面的<code>DOM</code>对象挂载在<code>fiber树</code>中首个<code>HostComponent</code>类型的节点上(具体来讲<code>DOM</code>对象是挂载在<code>fiber.stateNode</code>属性上)</li></ol></li></ul><p>这里再次回顾前文使用过的 2 棵 fiber 树, 可以验证上述特点:</p><ol><li>初次构造</li></ol><p><img src="'+l+'" alt=""></p><ol start="2"><li>对比更新</li></ol><p><img src="'+u+'" alt=""></p><h2 id="commitroot" tabindex="-1"><a class="header-anchor" href="#commitroot" aria-hidden="true">#</a> commitRoot</h2>',11),M={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1879-L2254",target:"_blank",rel:"noopener noreferrer"},L=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> renderPriorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">runWithPriority</span><span class="token punctuation">(</span>
    ImmediateSchedulerPriority<span class="token punctuation">,</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),S=s("code",null,"commitRoot",-1),j=s("code",null,"渲染优先级",-1),I=s("code",null,"调度优先级",-1),F=s("code",null,"commitRootImpl",-1),U=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ... 省略部分无关代码</span>
<span class="token keyword">function</span> <span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> renderPriorityLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ============ 渲染前: 准备 ============</span>

  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">const</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes<span class="token punctuation">;</span>

  <span class="token comment">// 清空FiberRoot对象上的属性</span>
  root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重置全局变量</span>
    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 再次更新副作用队列</span>
  <span class="token keyword">let</span> firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&gt;</span> PerformedWork<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认情况下fiber节点的副作用队列是不包括自身的</span>
    <span class="token comment">// 如果根节点有副作用, 则将根节点添加到副作用队列的末尾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      finishedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ============ 渲染 ============</span>
  <span class="token keyword">let</span> firstEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>firstEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
    executionContext <span class="token operator">|=</span> CommitContext<span class="token punctuation">;</span>
    <span class="token comment">// 阶段1: dom突变之前</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 阶段2: dom突变, 界面发生改变</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 恢复界面状态</span>
    <span class="token function">resetAfterCommit</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 切换current指针</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>

    <span class="token comment">// 阶段3: layout阶段, 调用生命周期componentDidUpdate和回调函数等</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ============ 渲染后: 重置与清理 ============</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 有被动作用(使用useEffect), 保存一些全局变量</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 分解副作用队列链表, 辅助垃圾回收</span>
    <span class="token comment">// 如果有被动作用(使用useEffect), 会把分解操作放在flushPassiveEffects函数中</span>
    nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> nextNextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
      nextEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Deletion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      nextEffect <span class="token operator">=</span> nextNextEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 重置一些全局变量(省略这部分代码)...</span>
  <span class="token comment">// 下面代码用于检测是否有新的更新任务</span>
  <span class="token comment">// 比如在componentDidMount函数中, 再次调用setState()</span>

  <span class="token comment">// 1. 检测常规(异步)任务, 如果有则会发起异步调度(调度中心\`scheduler\`只能异步调用)</span>
  <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 检测同步任务, 如果有则主动调用flushSyncCallbackQueue(无需再次等待scheduler调度), 再次进入fiber树构造循环</span>
  <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>commitRootImpl</code>函数中, 可以根据是否调用渲染, 把整个<code>commitRootImpl</code>分为 3 段(分别是<code>渲染前</code>, <code>渲染</code>, <code>渲染后</code>).</p><h3 id="渲染前" tabindex="-1"><a class="header-anchor" href="#渲染前" aria-hidden="true">#</a> 渲染前</h3><p>为接下来正式渲染, 做一些准备工作. 主要包括:</p><ol><li>设置全局状态(如: 更新<code>fiberRoot</code>上的属性)</li><li>重置全局变量(如: <code>workInProgressRoot</code>, <code>workInProgress</code>等)</li><li>再次更新副作用队列: 只针对根节点<code>fiberRoot.finishedWork</code><ul><li>默认情况下根节点的副作用队列是不包括自身的, 如果根节点有副作用, 则将根节点添加到副作用队列的末尾</li><li>注意只是延长了副作用队列, 但是<code>fiberRoot.lastEffect</code>指针并没有改变. 比如首次构造时, 根节点拥有<code>Snapshot</code>标记:</li></ul></li></ol><p><img src="`+m+'" alt=""></p><h3 id="渲染" tabindex="-1"><a class="header-anchor" href="#渲染" aria-hidden="true">#</a> 渲染</h3><p><code>commitRootImpl</code>函数中, 渲染阶段的主要逻辑是处理副作用队列, 将最新的 DOM 节点(已经在内存中, 只是还没渲染)渲染到界面上.</p><p>整个渲染过程被分为 3 个函数分布实现:</p><ol><li><code>commitBeforeMutationEffects</code><ul><li>dom 变更之前, 处理副作用队列中带有<code>Snapshot</code>,<code>Passive</code>标记的<code>fiber</code>节点.</li></ul></li><li><code>commitMutationEffects</code><ul><li>dom 变更, 界面得到更新. 处理副作用队列中带有<code>Placement</code>, <code>Update</code>, <code>Deletion</code>, <code>Hydrating</code>标记的<code>fiber</code>节点.</li></ul></li><li><code>commitLayoutEffects</code><ul><li>dom 变更后, 处理副作用队列中带有<code>Update | Callback</code>标记的<code>fiber</code>节点.</li></ul></li></ol><p>通过上述源码分析, 可以把<code>commitRootImpl</code>的职责概括为 2 个方面:</p><ol><li>处理副作用队列. (步骤 1,2,3 都会处理, 只是处理节点的标识<code>fiber.flags</code>不同).</li><li>调用渲染器, 输出最终结果. (在步骤 2: <code>commitMutationEffects</code>中执行).</li></ol><p>所以<code>commitRootImpl</code>是处理<code>fiberRoot.finishedWork</code>这棵即将被渲染的<code>fiber</code>树, 理论上无需关心这棵<code>fiber</code>树是如何产生的(可以是<code>首次构造</code>产生, 也可以是<code>对比更新</code>产生). 为了清晰简便, 在下文的所有图示都使用<code>初次创建的fiber树结构</code>来进行演示.</p><p>这 3 个函数处理的对象是<code>副作用队列</code>和<code>DOM对象</code>.</p><p>所以无论<code>fiber树</code>结构有多么复杂, 到了<code>commitRoot</code>阶段, 实际起作用的只有 2 个节点:</p><ul><li><code>副作用队列</code>所在节点: 根节点, 即<code>HostRootFiber</code>节点.</li><li><code>DOM对象</code>所在节点: 从上至下首个<code>HostComponent</code>类型的<code>fiber</code>节点, 此节点 \b<code>fiber.stateNode</code>实际上指向最新的 DOM 树.</li></ul><p>下图为了清晰, 省略了一些无关引用, 只留下<code>commitRoot</code>阶段实际会用到的<code>fiber</code>节点:</p><p><img src="'+v+`" alt=""></p><h4 id="commitbeforemutationeffects" tabindex="-1"><a class="header-anchor" href="#commitbeforemutationeffects" aria-hidden="true">#</a> commitBeforeMutationEffects</h4><p>第一阶段: dom 变更之前, 处理副作用队列中带有<code>Snapshot</code>,<code>Passive</code>标记的<code>fiber</code>节点.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ... 省略部分无关代码</span>
<span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token comment">// 处理\`Snapshot\`标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 处理\`Passive\`标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Passive标记只在使用了hook, useEffect会出现. 所以此处是针对hook对象的处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：<code>commitBeforeMutationEffectOnFiber</code>实际上对应了<code>commitBeforeMutationLifeCycles</code>函数，在导入时进行了重命名</p><ol><li>处理<code>Snapshot</code>标记</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">Block</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>

          <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> prevProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsMutation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> root <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
          <span class="token function">clearContainer</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostText</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IncompleteClassComponent</span><span class="token operator">:</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从源码中可以看到, 与<code>Snapshot</code>标记相关的类型只有<code>ClassComponent</code>和<code>HostRoot</code>.</p><ul><li>对于<code>ClassComponent</code>类型节点, 调用了<code>instance.getSnapshotBeforeUpdate</code>生命周期函数</li><li>对于<code>HostRoot</code>类型节点, 调用<code>clearContainer</code>清空了容器节点(即<code>div#root</code>这个 dom 节点).</li></ul><ol start="2"><li>处理<code>Passive</code>标记</li></ol><p><code>Passive</code>标记只会在使用了<code>hook</code>对象的<code>function</code>类型的节点上存在, 后续的执行过程在<code>hook原理</code>章节中详细说明. 此处我们需要了解在<code>commitRoot</code>的第一个阶段, 为了处理<code>hook</code>对象(如<code>useEffect</code>), 通过<code>scheduleCallback</code>单独注册了一个调度任务<code>task</code>, 等待调度中心<code>scheduler</code>处理.</p>`,28),O=s("code",null,"scheduler",-1),H=s("code",null,"task",-1),N=s("code",null,"MessageChannel",-1),B=o(`<p>小测试:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 以下示例代码中的输出顺序为 1, 3, 4, 2</span>
<span class="token keyword">function</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="commitmutationeffects" tabindex="-1"><a class="header-anchor" href="#commitmutationeffects" aria-hidden="true">#</a> commitMutationEffects</h4><p>第二阶段: dom 变更, 界面得到更新. 处理副作用队列中带有<code>ContentReset</code>, <code>Ref</code>, <code>Placement</code>, <code>Update</code>, <code>Deletion</code>, <code>Hydrating</code>标记的<code>fiber</code>节点.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ...省略部分无关代码</span>
<span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">renderPriorityLevel</span><span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理Ref</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 先清空ref, 在commitRoot的第三阶段(dom变更后), 再重新赋值</span>
      <span class="token function">commitDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 处理DOM突变</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">const</span> primaryFlags <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Placement <span class="token operator">|</span> Update <span class="token operator">|</span> Deletion <span class="token operator">|</span> Hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>primaryFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Placement</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 新增节点</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span> <span class="token comment">// 注意Placement标记会被清除</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// Placement</span>
        <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>Placement<span class="token punctuation">;</span>
        <span class="token comment">// Update</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Update</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 更新节点</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
        <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token literal-property property">Deletion</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 删除节点</span>
        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> renderPriorityLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>处理 DOM 突变:</p><ol><li><code>新增</code>: 函数调用栈 <code>commitPlacement</code> -&gt; <code>insertOrAppendPlacementNode</code> -&gt; <code>appendChild</code></li><li><code>更新</code>: 函数调用栈 <code>commitWork</code> -&gt; <code>commitUpdate</code></li><li><code>删除</code>: 函数调用栈 <code>commitDeletion</code> -&gt; <code>removeChild</code></li></ol>`,7),Q=s("code",null,"appendChild, commitUpdate, removeChild",-1),A=s("code",null,"react-dom",-1),z={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/README.md#practical-examples",target:"_blank",rel:"noopener noreferrer"},T=s("code",null,"HostConfig",-1),V={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMHostConfig.js",target:"_blank",rel:"noopener noreferrer"},q=s("code",null,"react-dom",-1),Y=o('<p>注意: <code>commitMutationEffects</code>执行之后, 在<code>commitRootImpl</code>函数中切换当前<code>fiber</code>树(<code>root.current = finishedWork</code>),保证<code>fiberRoot.current</code>指向代表当前界面的<code>fiber树</code>.</p><p><img src="'+f+`" alt=""></p><h4 id="commitlayouteffects" tabindex="-1"><a class="header-anchor" href="#commitlayouteffects" aria-hidden="true">#</a> commitLayoutEffects</h4><p>第三阶段: dom 变更后, 处理副作用队列中带有<code>Update, Callback, Ref</code>标记的<code>fiber</code>节点.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ...省略部分无关代码</span>
<span class="token keyword">function</span> <span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span> <span class="token literal-property property">committedLanes</span><span class="token operator">:</span> Lanes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token comment">// 处理 Update和Callback标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>Update <span class="token operator">|</span> Callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
      <span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">,</span> committedLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重新设置ref</span>
      <span class="token function">commitAttachRef</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>核心逻辑都在<code>commitLayoutEffectOnFiber-&gt;commitLifeCycles</code>函数中.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ...省略部分无关代码</span>
<span class="token keyword">function</span> <span class="token function">commitLifeCycles</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">finishedRoot</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">committedLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 初次渲染: 调用 componentDidMount</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> prevProps <span class="token operator">=</span>
            finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
              <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedProps
              <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
          <span class="token comment">// 更新阶段: 调用 componentDidUpdate</span>
          instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>
            prevProps<span class="token punctuation">,</span>
            prevState<span class="token punctuation">,</span>
            instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span>
        <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>updateQueue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理update回调函数 如: this.setState({}, callback)</span>
        <span class="token function">commitUpdateQueue</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> updateQueue<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">instance</span><span class="token operator">:</span> Instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">const</span> props <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
        <span class="token comment">// 设置focus等原生状态</span>
        <span class="token function">commitMount</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>commitLifeCycles</code>函数中:</p><ul><li>对于<code>ClassComponent</code>节点, 调用生命周期函数<code>componentDidMount</code>或<code>componentDidUpdate</code>, 调用<code>update.callback</code>回调函数.</li><li>对于<code>HostComponent</code>节点, 如有<code>Update</code>标记, 需要设置一些原生状态(如: <code>focus</code>等)</li></ul><h3 id="渲染后" tabindex="-1"><a class="header-anchor" href="#渲染后" aria-hidden="true">#</a> 渲染后</h3><p>执行完上述步骤之后, 本次渲染任务就已经完成了. 在渲染完成后, 需要做一些重置和清理工作:</p><ol><li><p>清除副作用队列</p><ul><li>由于副作用队列是一个链表, 由于单个<code>fiber</code>对象的引用关系, 无法被<code>gc回收</code>.</li><li>将链表全部拆开, 当<code>fiber</code>对象不再使用的时候, 可以被<code>gc回收</code>.</li></ul></li></ol><p><img src="`+b+`" alt=""></p><ol start="2"><li>检测更新 <ul><li>在整个渲染过程中, 有可能产生新的<code>update</code>(比如在<code>componentDidMount</code>函数中, 再次调用<code>setState()</code>).</li><li>如果是常规(异步)任务, 不用特殊处理, 调用<code>ensureRootIsScheduled</code>确保任务已经注册到调度中心即可.</li><li>如果是同步任务, 则主动调用<code>flushSyncCallbackQueue</code>(无需再次等待 scheduler 调度), 再次进入 fiber 树构造循环</li></ul></li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 清除副作用队列</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 有被动作用(使用useEffect), 保存一些全局变量</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 分解副作用队列链表, 辅助垃圾回收.</span>
  <span class="token comment">// 如果有被动作用(使用useEffect), 会把分解操作放在flushPassiveEffects函数中</span>
  nextEffect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextNextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
    nextEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Deletion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextNextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 重置一些全局变量(省略这部分代码)...</span>
<span class="token comment">// 下面代码用于检测是否有新的更新任务</span>
<span class="token comment">// 比如在componentDidMount函数中, 再次调用setState()</span>

<span class="token comment">// 1. 检测常规(异步)任务, 如果有则会发起异步调度(调度中心\`scheduler\`只能异步调用)</span>
<span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. 检测同步任务, 如果有则主动调用flushSyncCallbackQueue(无需再次等待scheduler调度), 再次进入fiber树构造循环</span>
<span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本节分析了<code>fiber 树渲染</code>的处理过程, 从宏观上看<code>fiber 树渲染</code>位于<code>reconciler 运作流程</code>中的输出阶段, 是整个<code>reconciler 运作流程</code>的链路中最后一环(从输入到输出). 本节根据源码, 具体从<code>渲染前, 渲染, 渲染后</code>三个方面分解了<code>commitRootImpl</code>函数. 其中最核心的<code>渲染</code>逻辑又分为了 3 个函数, 这 3 个函数共同处理了有副作用<code>fiber</code>节点, 并通过渲染器<code>react-dom</code>把最新的 DOM 对象渲染到界面上.</p>`,17);function G(J,K){const e=c("RouterLink"),p=c("ExternalLinkIcon");return d(),k("div",null,[h,s("p",null,[n("在正式分析"),w,n("之前, 再次回顾一下"),a(e,{to:"/docs/react/principle-analysis/reconciler-workflow.html"},{default:t(()=>[n("reconciler 运作流程")]),_:1}),n("的 4 个阶段:")]),E,s("ol",null,[s("li",null,[n("输入阶段: 衔接"),g,n("包, 承接"),_,n("请求(参考"),a(e,{to:"/docs/react/principle-analysis/bootstrap.html"},{default:t(()=>[n("React 应用的启动过程")]),_:1}),n(").")]),s("li",null,[n("注册调度任务: 与调度中心("),x,n("包)交互, 注册调度任务"),R,n(", 等待任务回调(参考"),a(e,{to:"/docs/react/principle-analysis/scheduler.html"},{default:t(()=>[n("React 调度原理(scheduler)")]),_:1}),n(").")]),s("li",null,[n("执行任务回调: 在内存中构造出"),C,n("和"),P,n("对象(参考"),a(e,{to:"/docs/react/principle-analysis/fibertree-create.html"},{default:t(()=>[n("fiber 树构造(初次创建)")]),_:1}),n("和 fiber 树构造(对比更新)).")]),W]),D,s("p",null,[n("整个渲染逻辑都在"),s("a",M,[n("commitRoot 函数中"),a(p)]),n(":")]),L,s("p",null,[n("在"),S,n("中同时使用到了"),j,n("和"),I,n(", 有关优先级的讨论, 在前文已经做出了说明(参考"),a(e,{to:"/docs/react/principle-analysis/priority.html"},{default:t(()=>[n("React 中的优先级管理")]),_:1}),n("和"),a(e,{to:"/docs/react/principle-analysis/fibertree-prepare.html#%E4%BC%98%E5%85%88%E7%BA%A7"},{default:t(()=>[n("fiber 树构造(基础准备)#优先级")]),_:1}),n("), 本节不再赘述. 最后的实现是通过"),F,n("函数:")]),U,s("p",null,[n("注意: 通过调度中心"),O,n("调度的任务"),H,n("均是通过"),N,n("触发, 都是异步执行(可参考"),a(e,{to:"/docs/react/principle-analysis/scheduler.html"},{default:t(()=>[n("React 调度原理(scheduler)")]),_:1}),n(").")]),B,s("p",null,[n("最终会调用"),Q,n("这些"),A,n("包中的函数. 它们是"),s("a",z,[T,n("协议"),a(p)]),n("("),s("a",V,[n("源码在 ReactDOMHostConfig.js 中"),a(p)]),n(")中规定的标准函数, 在渲染器"),q,n("包中进行实现. 这些函数就是直接操作 DOM, 所以执行之后, 界面也会得到更新.")]),Y])}const sn=r(y,[["render",G],["__file","fibertree-commit.html.vue"]]);export{sn as default};
