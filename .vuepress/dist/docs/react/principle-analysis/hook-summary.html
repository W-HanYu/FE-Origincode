<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.60">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <title>Hook 原理(概览) | Ustinian</title><meta name="description" content="react、vue主流框架源码的输出，包括原理解析以及框架中的算法以及面试频率很高的相关知识点，带你更深入的学习底层原理。">
    <link rel="modulepreload" href="/FE-Origincode/assets/app-f2c4a527.js"><link rel="modulepreload" href="/FE-Origincode/assets/framework-e1bed10d.js"><link rel="modulepreload" href="/FE-Origincode/assets/hook-summary.html-9e07beb9.js"><link rel="modulepreload" href="/FE-Origincode/assets/hook-summary.html-677a2845.js"><link rel="prefetch" href="/FE-Origincode/assets/index.html-6d5e9dd3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-cd8c9a64.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-e901a9ed.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-e5e90244.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-06cde299.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-adbe0805.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-dd57d590.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-046de93b.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-6cf06f14.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-272107e1.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/guide.html-dec02f02.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/api.html-525462dc.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/home.html-f2247897.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/plugin.html-130a470f.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/theme.html-113726b9.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/121501.html-4be63e89.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/121501.html-b0306309.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/092101.html-7d9ce6d0.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/bitfield.html-05528e73.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/dfs.html-27a796e2.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/diff.html-4c99cb63.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/heapsort.html-b2adbf41.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/linkedlist.html-1e639661.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/stack.html-575417ff.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/092101.html-d9abbfc6.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/bootstrap.html-6869fd19.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/context.html-0d1c94bc.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-commit.html-a02c0b97.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-create.html-ac12eaf3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-prepare.html-c3de910a.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-update.html-b91a5eb2.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/hook-effect.html-77b3b354.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/hook-state.html-54e4d6ec.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/macro-structure.html-76e1ec09.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/object-structure.html-831fac88.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/priority.html-fd7b2162.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/reconciler-workflow.html-e5dbdca0.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/scheduler.html-611c1139.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/state-effects.html-618e8130.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/synthetic-event.html-2b0e06e6.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/workloop.html-cdf330af.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/404.html-60b35caa.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-660e4bef.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-c62ed802.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-40bced6f.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-ef51ba1b.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-d7e5408a.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-385dcb56.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-48e1c605.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-bdec80a5.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-3c78780e.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/index.html-47e4ee8b.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/guide.html-15eec75c.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/api.html-24420321.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/home.html-488bf774.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/plugin.html-e981e756.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/theme.html-034ac997.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/121501.html-e8542f91.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/121501.html-c9fc5001.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/092101.html-d894199d.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/bitfield.html-d56221bc.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/dfs.html-a38c7958.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/diff.html-1e9f68be.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/heapsort.html-5f570ec7.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/linkedlist.html-eda1cfe6.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/stack.html-b93207ae.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/092101.html-bd00ebb3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/bootstrap.html-8d1e9840.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/context.html-52e26fbf.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-commit.html-0fb065d5.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-create.html-92509595.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-prepare.html-bed44bc3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/fibertree-update.html-8b9e8f16.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/hook-effect.html-d9a5b83a.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/hook-state.html-450521e3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/macro-structure.html-a095c7be.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/object-structure.html-3607d7cc.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/priority.html-3f6ab3ad.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/reconciler-workflow.html-5b5db7a6.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/scheduler.html-fbd5e5d7.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/state-effects.html-96c587f3.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/synthetic-event.html-c4067301.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/workloop.html-ae218d15.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/404.html-7c90b0cc.js" as="script"><link rel="prefetch" href="/FE-Origincode/assets/reco-valine-a0c1af1f.js" as="script">
    <link rel="preload" href="/FE-Origincode/assets/style-003d9841.css" as="style"><link rel="stylesheet" href="/FE-Origincode/assets/style-003d9841.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><div class="common-wrapper show-series show-catalog"><div><header class="navbar-container"><!--[--><div class="site-brand nav-item"><img class="logo" src="/FE-Origincode/logo.png" alt="Ustinian"><a href="/FE-Origincode/" class="site-name can-hide">Ustinian</a></div><div class="nav-item navbar-links-wrapper" style=""><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/FE-Origincode/" class="link router-link-active" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="React"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="React"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/FE-Origincode/docs/react/principle-analysis/macro-structure" class="link" aria-label="原理篇"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->原理篇<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/FE-Origincode/docs/react/algorithm/diff" class="link" aria-label="算法篇"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法篇<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/FE-Origincode/tags/tag1/1/" class="link" aria-label="Vue"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vue<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="小程序"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->小程序<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="小程序"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->小程序<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/FE-Origincode/docs/theme-reco/theme" class="link" aria-label="vuepress-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-reco<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/FE-Origincode/blogs/other/guide" class="link" aria-label="vuepress-theme-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-theme-reco<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><span class="xicon-container btn-toggle-dark-mode btn--dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div><!--]--></header><div class="mobile-menus-container"><nav class="navbar-links mobile"><!--[--><div class="navbar-links__item"><a href="/FE-Origincode/" class="link router-link-active" aria-label="首页"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->首页<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="React"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="React"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->React<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/FE-Origincode/docs/react/principle-analysis/macro-structure" class="link" aria-label="原理篇"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->原理篇<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/FE-Origincode/docs/react/algorithm/diff" class="link" aria-label="算法篇"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->算法篇<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/FE-Origincode/tags/tag1/1/" class="link" aria-label="Vue"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Vue<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="小程序"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->小程序<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="小程序"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->小程序<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/FE-Origincode/docs/theme-reco/theme" class="link" aria-label="vuepress-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-reco<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/FE-Origincode/blogs/other/guide" class="link" aria-label="vuepress-theme-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->vuepress-theme-reco<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--></nav><div class="appearance"><span>Appearance</span><span class="xicon-container btn-toggle-dark-mode"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M15 2h2v3h-2z" fill="currentColor"></path><path d="M27 15h3v2h-3z" fill="currentColor"></path><path d="M15 27h2v3h-2z" fill="currentColor"></path><path d="M2 15h3v2H2z" fill="currentColor"></path><path d="M5.45 6.884l1.414-1.415l2.121 2.122l-1.414 1.414z" fill="currentColor"></path><path d="M23 7.58l2.121-2.12l1.414 1.414l-2.121 2.121z" fill="currentColor"></path><path d="M23.002 24.416l1.415-1.414l2.12 2.122l-1.413 1.414z" fill="currentColor"></path><path d="M5.47 25.13L7.59 23L9 24.42l-2.12 2.12l-1.41-1.41z" fill="currentColor"></path><path d="M16 8a8 8 0 1 0 8 8a8 8 0 0 0-8-8zm0 14a6 6 0 0 1 0-12z" fill="currentColor"></path></svg></span></div></div><div class="series-mask"></div><aside class="series-container"><div class="site-brand"><img class="logo" src="/FE-Origincode/logo.png" alt="Ustinian"><a href="/FE-Origincode/" class="site-name can-hide">Ustinian</a></div><!--[--><!--[--><section class="series-group series-item"><h5 class="series-heading">基础概念</h5><ul><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/macro-structure.html" class="link series-item" aria-label="宏观包结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->宏观包结构<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/workloop.html" class="link series-item" aria-label="两大工作循环"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->两大工作循环<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/object-structure.html" class="link series-item" aria-label="高频对象"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->高频对象<!--]--></span></span><!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading">运行核心</h5><ul><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/bootstrap.html" class="link series-item" aria-label="启动过程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->启动过程<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/reconciler-workflow.html" class="link series-item" aria-label="reconciler 运作流程"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->reconciler 运作流程<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/priority.html" class="link series-item" aria-label="优先级管理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->优先级管理<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/scheduler.html" class="link series-item" aria-label="调度原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->调度原理<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/fibertree-prepare.html" class="link series-item" aria-label="fiber 树构造(基础准备)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->fiber 树构造(基础准备)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/fibertree-create.html" class="link series-item" aria-label="fiber 树构造(初次创建)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->fiber 树构造(初次创建)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/fibertree-update.html" class="link series-item" aria-label="fiber 树构造(对比更新)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->fiber 树构造(对比更新)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/fibertree-commit.html" class="link series-item" aria-label="fiber 树渲染"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->fiber 树渲染<!--]--></span></span><!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--[--><section class="series-group series-item"><h5 class="series-heading active">状态管理</h5><ul><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/state-effects.html" class="link series-item" aria-label="状态与副作用"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->状态与副作用<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html" class="router-link-active router-link-exact-active link router-link-active series-item active" aria-label="Hook 原理(概览)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 原理(概览)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/hook-state.html" class="link series-item" aria-label="Hook 原理(状态Hook)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 原理(状态Hook)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/hook-effect.html" class="link series-item" aria-label="Hook 原理(副作用Hook)"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 原理(副作用Hook)<!--]--></span></span><!--[--><!--]--></a><!--]--></li><li><!--[--><a href="/FE-Origincode/docs/react/principle-analysis/context.html" class="link series-item" aria-label="context 原理"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->context 原理<!--]--></span></span><!--[--><!--]--></a><!--]--></li></ul></section><!--]--><!--]--></aside><!--[--><main class="page-container"><h1 class="page-title">Hook 原理(概览)</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->wangtao<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->2023/06/10<!--]--></span></span><!----><!----><!----></div><div class="theme-reco-default-content"><div><h1 id="hook-原理-概览" tabindex="-1"><a class="header-anchor" href="#hook-原理-概览" aria-hidden="true">#</a> Hook 原理(概览)</h1><p>在前文<a href="/FE-Origincode/docs/react/principle-analysis/state-effects.html" class="">状态与副作用</a>中, 总结了<code>class组件, function组件</code>中通过<code>api</code>去改变<code>fiber节点</code>的<code>状态</code>和<code>副作用</code>. 其中对于<code>function组件</code>来讲, 其内部则需要依靠<code>Hook</code>来实现.</p><p>官方文档上专门用了一个版块来介绍<a href="https://zh-hans.reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener noreferrer">Hook<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>, 这里摘抄了几个比较关心的问题(其他<code>FAQ</code>请移步官网):</p><ol><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation" target="_blank" rel="noopener noreferrer">引入<code>Hook</code>的动机?<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>在组件之间复用状态逻辑很难; 复杂组件变得难以理解; 难以理解的 class. 为了解决这些实际开发痛点, 引入了<code>Hook</code>.</li></ul></li><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-state.html#whats-a-hook" target="_blank" rel="noopener noreferrer"><code>Hook</code> 是什么? 什么时候会用 <code>Hook</code>?<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li><code>Hook</code> 是一个特殊的函数, 它可以让你“钩入” <code>React</code> 的特性. 如, <code>useState</code> 是允许你在 <code>React</code> 函数组件中添加 <code>state</code> 的 <code>Hook</code>.</li><li>如果你在编写函数组件并意识到需要向其添加一些 <code>state</code>, 以前的做法是必须将其转化为 <code>class</code>. 现在你可以在现有的函数组件中使用 <code>Hook</code>.</li></ul></li><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render" target="_blank" rel="noopener noreferrer"><code>Hook</code> 会因为在渲染时创建函数而变慢吗?<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><ul><li>不会. 在现代浏览器中,闭包和类的原始性能只有在极端场景下才会有明显的差别. 除此之外,可以认为 <code>Hook</code> 的设计在某些方面更加高效: <ul><li><code>Hook</code> 避免了 <code>class</code> 需要的额外开支,像是创建类实例和在构造函数中绑定事件处理器的成本.</li><li>符合语言习惯的代码在使用 <code>Hook</code> 时不需要很深的组件树嵌套. 这个现象在使用<code>高阶组件</code>、<code>render props</code>、和 <code>context</code> 的代码库中非常普遍. 组件树小了, <code>React</code> 的工作量也随之减少.</li></ul></li></ul></li></ol><p>所以<code>Hook</code>是<code>React</code>团队在大量实践后的产物, 更优雅的代替<code>class</code>, 且性能更高. 故从开发使用者的角度来讲, 应该拥抱<code>Hook</code>所带来的便利.</p><h2 id="hook-与-fiber" tabindex="-1"><a class="header-anchor" href="#hook-与-fiber" aria-hidden="true">#</a> Hook 与 Fiber</h2><p>通过官网文档的讲解, 能快速掌握<code>Hook</code>的使用. 再结合前文<a href="/FE-Origincode/docs/react/principle-analysis/state-effects.html" class="">状态与副作用</a>的介绍, 我们知道使用<code>Hook</code>最终也是为了控制<code>fiber节点</code>的<code>状态</code>和<code>副作用</code>. 从<code>fiber</code>视角, 状态和副作用相关的属性如下(这里不再解释单个属性的意义, 可以回顾<a href="/FE-Origincode/docs/react/principle-analysis/state-effects.html" class="">状态与副作用</a>):</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 1. fiber节点自身状态相关</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 2. fiber节点副作用(Effect)相关</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> Flags<span class="token punctuation">,</span>
  <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">firstEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用<code>Hook</code>的任意一个<code>api</code>, 最后都是为了控制上述这几个<code>fiber属性</code>.</p><h2 id="hook-数据结构" tabindex="-1"><a class="header-anchor" href="#hook-数据结构" aria-hidden="true">#</a> Hook 数据结构</h2><p>在<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L95-L140" target="_blank" rel="noopener noreferrer">ReactFiberHooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>中, 定义了<code>Hook</code>的数据结构:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>type Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">lane</span><span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eagerReducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eagerState</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">next</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  priority<span class="token operator">?</span><span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

type UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">pending</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> mixed<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastRenderedReducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastRenderedState</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type Hook <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 当前状态</span>
  <span class="token literal-property property">baseState</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 基状态</span>
  <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 基队列</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 更新队列</span>
  <span class="token literal-property property">next</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// next指针</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从定义来看, <code>Hook</code>对象共有 5 个属性(有关这些属性的应用, 将在<code>Hook 原理(状态)</code>章节中具体分析.):</p><ol><li><code>hook.memoizedState</code>: 保持在内存中的局部状态.</li><li><code>hook.baseState</code>: <code>hook.baseQueue</code>中所有<code>update</code>对象合并之后的状态.</li><li><code>hook.baseQueue</code>: 存储<code>update对象</code>的环形链表, 只包括高于本次渲染优先级的<code>update对象</code>.</li><li><code>hook.queue</code>: 存储<code>update对象</code>的环形链表, 包括所有优先级的<code>update对象</code>.</li><li><code>hook.next</code>: <code>next</code>指针, 指向链表中的下一个<code>hook</code>.</li></ol><p>所以<code>Hook</code>是一个链表, 单个<code>Hook</code>拥有自己的状态<code>hook.memoizedState</code>和自己的更新队列<code>hook.queue</code>(有关 Hook 状态的分析, 在<code>Hook原理(状态)</code>章节中解读).</p><p><img src="/FE-Origincode/assets/hook-linkedlist-bc498055.png" alt=""></p><p>注意: 其中<code>hook.queue</code>与<code>fiber.updateQueue</code>虽然都是<code>update环形链表</code>, 尽管<code>update对象</code>的数据结构与处理方式都高度相似, 但是这 2 个队列中的<code>update对象</code>是完全独立的. <code>hook.queue</code>只作用于<code>hook对象</code>的状态维护, 切勿与<code>fiber.updateQueue</code>混淆.</p><h2 id="hook-分类" tabindex="-1"><a class="header-anchor" href="#hook-分类" aria-hidden="true">#</a> Hook 分类</h2><p>在<code>v17.0.2</code>中, 共定义了<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125" target="_blank" rel="noopener noreferrer">14 种 Hook<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> type HookType <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token string">&#39;useState&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useReducer&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useContext&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useRef&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useEffect&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useLayoutEffect&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useCallback&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useMemo&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useImperativeHandle&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useDebugValue&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useDeferredValue&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useTransition&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useMutableSource&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useOpaqueIdentifier&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>官网上已经将其分为了 2 个类别, 状态<code>Hook</code>(<code>State Hook</code>), 和副作用<code>Hook</code>(<code>Effect Hook</code>).</p><p>这里我们可以结合前文<a href="/FE-Origincode/docs/react/principle-analysis/state-effects.html" class="">状态与副作用</a>, 从<code>fiber</code>的视角去理解<code>状态Hook</code>与<code>副作用Hook</code>的区别.</p><h3 id="状态-hook" tabindex="-1"><a class="header-anchor" href="#状态-hook" aria-hidden="true">#</a> 状态 Hook</h3><p>狭义上讲, <code>useState, useReducer</code>可以在<code>function组件</code>添加内部的<code>state</code>, 且<code>useState</code>实际上是<code>useReducer</code>的简易封装, 是一个最特殊(简单)的<code>useReducer</code>. 所以将<code>useState, useReducer</code>称为<code>状态Hook</code>.</p><p>广义上讲, 只要能实现数据持久化<code>且没有副作用</code>的<code>Hook</code>, 均可以视为<code>状态Hook</code>, 所以还包括<code>useContext, useRef, useCallback, useMemo</code>等. 这类<code>Hook</code>内部没有使用<code>useState/useReducer</code>, 但是它们也能实现多次<code>render</code>时, 保持其初始值不变(即数据持久化)且没有任何<code>副作用</code>.</p><p>得益于<a href="/FE-Origincode/docs/react/principle-analysis/fibertree-prepare.html#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF" class="">双缓冲技术(double buffering)</a>, 在多次<code>render</code>时, 以<code>fiber</code>为载体, 保证复用同一个<code>Hook</code>对象, 进而实现数据持久化. 具体实现细节, 在<code>Hook原理(状态)</code>章节中讨论.</p><h3 id="副作用-hook" tabindex="-1"><a class="header-anchor" href="#副作用-hook" aria-hidden="true">#</a> 副作用 Hook</h3><p>回到<code>fiber</code>视角, <code>状态Hook</code>实现了状态持久化(等同于<code>class组件</code>维护<code>fiber.memoizedState</code>), 那么<code>副作用Hook</code>则会修改<code>fiber.flags</code>. (通过前文<code>fiber树构造</code>系列的解读, 我们知道在<code>performUnitOfWork-&gt;completeWork</code>阶段, 所有存在副作用的<code>fiber</code>节点, 都会被添加到父节点的<code>副作用队列</code>后, 最后在<code>commitRoot</code>阶段处理这些<code>副作用节点</code>.)</p><p>另外, <code>副作用Hook</code>还提供了<code>副作用回调</code>(类似于<code>class组件</code>的生命周期回调), 比如:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 使用useEffect时, 需要传入一个副作用回调函数.</span>
<span class="token comment">// 在fiber树构造完成之后, commitRoot阶段会处理这些副作用回调</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;这是一个副作用回调函数&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>react</code>内部, <code>useEffect</code>就是最标准的<code>副作用Hook</code>. 其他比如<code>useLayoutEffect</code>以及<code>自定义Hook</code>, 如果要实现<code>副作用</code>, 必须直接或间接的调用<code>useEffect</code>.</p><p>有关<code>useEffect</code>具体实现细节, 在<code>Hook原理(副作用)</code>章节中讨论.</p><h3 id="组合-hook" tabindex="-1"><a class="header-anchor" href="#组合-hook" aria-hidden="true">#</a> 组合 Hook</h3><p>虽然官网并无<code>组合Hook</code>的说法, 但事实上大多数<code>Hook</code>(包括自定义<code>Hook</code>)都是由上述 2 种 <code>Hook</code>组合而成, 同时拥有这 2 种 Hook 的特性.</p><ul><li>在<code>react</code>内部有<code>useDeferredValue, useTransition, useMutableSource, useOpaqueIdentifier</code>等.</li><li>平时开发中, <code>自定义Hook</code>大部分都是组合 Hook.</li></ul><p>比如官网上的<a href="https://zh-hans.reactjs.org/docs/hooks-custom.html#extracting-a-custom-hook" target="_blank" rel="noopener noreferrer">自定义 Hook<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>例子:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span><span class="token parameter">friendID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 调用useState, 创建一个状态Hook</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 调用useEffect, 创建一个副作用Hook</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="调用-function-前" tabindex="-1"><a class="header-anchor" href="#调用-function-前" aria-hidden="true">#</a> 调用 function 前</h2><p>在调用<code>function</code>之前, <code>react</code>内部还需要提前做一些准备工作.</p><h3 id="处理函数" tabindex="-1"><a class="header-anchor" href="#处理函数" aria-hidden="true">#</a> 处理函数</h3><p>从<code>fiber树构造</code>的视角来看, 不同的<code>fiber</code>类型, 只需要调用不同的<code>处理函数</code>返回<code>fiber子节点</code>. 所以在<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3340-L3354" target="_blank" rel="noopener noreferrer">performUnitOfWork-&gt;beginWork<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>函数中, 调用了多种<code>处理函数</code>. 从调用方来讲, 无需关心<code>处理函数</code>的内部实现(比如<code>updateFunctionComponent</code>内部使用了<code>Hook对象</code>, <code>updateClassComponent</code>内部使用了<code>class实例</code>).</p><p>本节讨论<code>Hook</code>, 所以列出其中的<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L702-L783" target="_blank" rel="noopener noreferrer">updateFunctionComponent<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>函数:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 只保留FunctionComponent相关:</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateLanes <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lanes<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
  <span class="token literal-property property">nextProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderLanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...省略无关代码</span>
  <span class="token keyword">let</span> context<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 进入Hooks相关逻辑, 最后返回下级ReactElement对象</span>
  nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    nextProps<span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    renderLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 进入reconcile函数, 生成下级fiber节点</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回下级fiber节点</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>updateFunctionComponent</code>函数中调用了<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476" target="_blank" rel="noopener noreferrer">renderWithHooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>(位于<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js" target="_blank" rel="noopener noreferrer">ReactFiberHooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>) , 至此<code>Fiber</code>与<code>Hook</code>产生了关联.</p><h3 id="全局变量" tabindex="-1"><a class="header-anchor" href="#全局变量" aria-hidden="true">#</a> 全局变量</h3><p>在分析<code>renderWithHooks</code>函数前, 有必要理解<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js" target="_blank" rel="noopener noreferrer">ReactFiberHooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>头部定义的全局变量(源码中均有英文注释):</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 渲染优先级</span>
<span class="token keyword">let</span> <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token comment">// 当前正在构造的fiber, 等同于 workInProgress, 为了和当前hook区分, 所以将其改名</span>
<span class="token keyword">let</span> <span class="token literal-property property">currentlyRenderingFiber</span><span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Hooks被存储在fiber.memoizedState 链表上</span>
<span class="token keyword">let</span> <span class="token literal-property property">currentHook</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// currentHook = fiber(current).memoizedState</span>

<span class="token keyword">let</span> <span class="token literal-property property">workInProgressHook</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// workInProgressHook = fiber(workInProgress).memoizedState</span>

<span class="token comment">// 在function的执行过程中, 是否再次发起了更新. 只有function被完全执行之后才会重置.</span>
<span class="token comment">// 当render异常时, 通过该变量可以决定是否清除render过程中的更新.</span>
<span class="token keyword">let</span> <span class="token literal-property property">didScheduleRenderPhaseUpdate</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 在本次function的执行过程中, 是否再次发起了更新. 每一次调用function都会被重置</span>
<span class="token keyword">let</span> <span class="token literal-property property">didScheduleRenderPhaseUpdateDuringThisPass</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 在本次function的执行过程中, 重新发起更新的最大次数</span>
<span class="token keyword">const</span> <span class="token constant">RE_RENDER_LIMIT</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个变量的解释, 可以对照源码中的英文注释, 其中最重要的有:</p><ol><li><code>currentlyRenderingFiber</code>: 当前正在构造的 fiber, 等同于 workInProgress</li><li><code>currentHook 与 workInProgressHook</code>: 分别指向<code>current.memoizedState</code>和<code>workInProgress.memoizedState</code></li></ol><p>注: 有关<code>current</code>和<code>workInProgress</code>的区别, 请回顾<a href="/FE-Origincode/docs/react/principle-analysis/fibertree-prepare.html#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF" class="">双缓冲技术(double buffering)</a></p><h3 id="renderwithhooks-函数" tabindex="-1"><a class="header-anchor" href="#renderwithhooks-函数" aria-hidden="true">#</a> renderWithHooks 函数</h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476" target="_blank" rel="noopener noreferrer">renderWithHooks<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>源码看似较长, 但是去除 dev 后保留主干, 逻辑十分清晰. 以调用<code>function</code>为分界点, 逻辑被分为 3 个部分:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ...省略无关代码</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> renderWithHooks<span class="token operator">&lt;</span>Props<span class="token punctuation">,</span> SecondArg<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token function-variable function">Component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">p</span><span class="token operator">:</span> Props<span class="token punctuation">,</span> <span class="token literal-property property">arg</span><span class="token operator">:</span> SecondArg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> Props<span class="token punctuation">,</span>
  <span class="token literal-property property">secondArg</span><span class="token operator">:</span> SecondArg<span class="token punctuation">,</span>
  <span class="token literal-property property">nextRenderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token comment">// --------------- 1. 设置全局变量 -------------------</span>
  renderLanes <span class="token operator">=</span> nextRenderLanes<span class="token punctuation">;</span> <span class="token comment">// 当前渲染优先级</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span> <span class="token comment">// 当前fiber节点, 也就是function组件对应的fiber节点</span>

  <span class="token comment">// 清除当前fiber的遗留状态</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">// --------------- 2. 调用function,生成子级ReactElement对象 -------------------</span>
  <span class="token comment">// 指定dispatcher, 区分mount和update</span>
  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
    current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> HooksDispatcherOnMount
      <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>
  <span class="token comment">// 执行function函数, 其中进行分析Hooks的使用</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --------------- 3. 重置全局变量,并返回 -------------------</span>
  <span class="token comment">// 执行function之后, 还原被修改的全局变量, 不影响下一次调用</span>
  renderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  currentlyRenderingFiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>

  currentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>调用<code>function</code>前: 设置全局变量, 标记<code>渲染优先级</code>和当前<code>fiber</code>, 清除当前<code>fiber</code>的遗留状态.</li><li>调用<code>function</code>: 构造出<code>Hooks</code>链表, 最后生成子级<code>ReactElement</code>对象(<code>children</code>).</li><li>调用<code>function</code>后: 重置全局变量, 返回<code>children</code>. <ul><li>为了保证不同的<code>function</code>节点在调用时<code>renderWithHooks</code>互不影响, 所以退出时重置全局变量.</li></ul></li></ol><h2 id="调用-function" tabindex="-1"><a class="header-anchor" href="#调用-function" aria-hidden="true">#</a> 调用 function</h2><h3 id="hooks-构造" tabindex="-1"><a class="header-anchor" href="#hooks-构造" aria-hidden="true">#</a> Hooks 构造</h3><p>在<code>function</code>中, 如果使用了<code>Hook api</code>(如: <code>useEffect</code>, <code>useState</code>), 就会创建一个与之对应的<code>Hook</code>对象, 接下来重点分析这个创建过程.</p><p>有如下 demo: <a href="https://codesandbox.io/s/hook-summary-wb7zz?fontsize=14&amp;hidenavigation=1&amp;theme=dark" target="_blank" rel="noopener noreferrer"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit hook-summary"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. useState</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. useEffect</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">effect 1 created</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. useState</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. useEffect</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">effect 2 created</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setA</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>a<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>b<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>function</code>组件中, 同时使用了<code>状态Hook</code>和<code>副作用Hook</code>.</p><p>初次渲染时, 逻辑执行到<code>performUnitOfWork-&gt;beginWork-&gt;updateFunctionComponent-&gt;renderWithHooks</code>前, 内存结构如下(本节重点是<code>Hook</code>, 有关<code>fiber树构造</code>过程可回顾前文):</p><p><img src="/FE-Origincode/assets/mount-before-renderwithhooks-6d3a2d2a.png" alt=""></p><p>当执行<code>renderWithHooks</code>时, 开始调用<code>function</code>. 本例中, 在<code>function</code>内部, 共使用了 4 次<code>Hook api</code>, 依次调用<code>useState, useEffect, useState, useEffect</code>.</p><p>而<code>useState, useEffect</code>在<code>fiber</code>初次构造时分别对应<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1113-L1136" target="_blank" rel="noopener noreferrer">mountState<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1193-L1248" target="_blank" rel="noopener noreferrer">mountEffect-&gt;mountEffectImpl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> mountState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">initialState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags<span class="token punctuation">,</span> hookFlags<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>无论<code>useState, useEffect</code>, 内部都通过<code>mountWorkInProgressHook</code>创建一个 hook.</p><h3 id="链表存储" tabindex="-1"><a class="header-anchor" href="#链表存储" aria-hidden="true">#</a> 链表存储</h3><p>而<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L531-L550" target="_blank" rel="noopener noreferrer">mountWorkInProgressHook<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>非常简单:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">hook</span><span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token literal-property property">baseState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 链表中首个hook</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将hook添加到链表末尾</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑是创建<code>Hook</code>并挂载到<code>fiber.memoizedState</code>上, 多个<code>Hook</code>以链表结构保存.</p><p>本示例中, <code>function</code>调用之后则会创建 4 个<code>hook</code>, 这时的内存结构如下:</p><p><img src="/FE-Origincode/assets/mount-after-renderwithhooks-0f3f0adb.png" alt=""></p><p>可以看到: 无论<code>状态Hook</code>或<code>副作用Hook</code>都按照调用顺序存储在<code>fiber.memoizedState</code>链表中.</p><p><img src="/FE-Origincode/assets/mount-fiber-memoizedstate-2bfedd30.png" alt=""></p><h3 id="顺序克隆" tabindex="-1"><a class="header-anchor" href="#顺序克隆" aria-hidden="true">#</a> 顺序克隆</h3><p><code>fiber树构造(对比更新)</code>阶段, 执行<code>updateFunctionComponent-&gt;renderWithHooks</code>时再次调用<code>function</code>, <code>调用function前</code>的内存结构如下:</p><p><img src="/FE-Origincode/assets/update-before-renderwithhooks-0aae8e90.png" alt=""></p><p>注意: 在<code>renderWithHooks</code>函数中已经设置了<code>workInProgress.memoizedState = null</code>, 等待调用<code>function</code>时重新设置.</p><p>接下来调用<code>function</code>, 同样依次调用<code>useState, useEffect, useState, useEffect</code>. 而<code>useState, useEffect</code>在<code>fiber</code>对比更新时分别对应<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1138-L1142" target="_blank" rel="noopener noreferrer">updateState-&gt;updateReducer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和<a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1205-L1266" target="_blank" rel="noopener noreferrer">updateEffect-&gt;updateEffectImpl<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ----- 状态Hook --------</span>
<span class="token keyword">function</span> updateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token literal-property property">initialArg</span><span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
  init<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">I</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>

<span class="token comment">// ----- 副作用Hook --------</span>
<span class="token keyword">function</span> <span class="token function">updateEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags<span class="token punctuation">,</span> hookFlags<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>无论<code>useState, useEffect</code>, 内部调用<code>updateWorkInProgressHook</code>获取一个 hook.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// 1. 移动currentHook指针</span>
  <span class="token keyword">let</span> <span class="token literal-property property">nextCurrentHook</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nextCurrentHook <span class="token operator">=</span> currentHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. 移动workInProgressHook指针</span>
  <span class="token keyword">let</span> <span class="token literal-property property">nextWorkInProgressHook</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextWorkInProgressHook <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextWorkInProgressHook <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 渲染时更新: 本节不讨论</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>
    <span class="token comment">// 3. 克隆currentHook作为新的workInProgressHook.</span>
    <span class="token comment">// 随后逻辑与mountWorkInProgressHook一致</span>
    <span class="token keyword">const</span> <span class="token literal-property property">newHook</span><span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>

      <span class="token literal-property property">baseState</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>
      <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseQueue<span class="token punctuation">,</span>
      <span class="token literal-property property">queue</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>queue<span class="token punctuation">,</span>

      <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 注意next指针是null</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>updateWorkInProgressHook</code>函数逻辑简单: 目的是为了让<code>currentHook</code>和<code>workInProgressHook</code>两个指针同时向后移动.</p><ol><li>由于<code>renderWithHooks函数</code>设置了<code>workInProgress.memoizedState=null</code>, 所以<code>workInProgressHook</code>初始值必然为<code>null</code>, 只能从<code>currentHook</code>克隆.</li><li>而从<code>currentHook</code>克隆而来的<code>newHook.next=null</code>, 进而导致<code>workInProgressHook</code>链表需要完全重建.</li></ol><p>所以<code>function</code>执行完成之后, 有关<code>Hook</code>的内存结构如下:</p><p><img src="/FE-Origincode/assets/update-after-renderwithhooks-4735481a.png" alt=""></p><p>可以看到:</p><ol><li>以双缓冲技术为基础, 将<code>current.memoizedState</code>按照顺序克隆到了<code>workInProgress.memoizedState</code>中.</li><li><code>Hook</code>经过了一次克隆, 内部的属性(<code>hook.memoizedState</code>等)都没有变动, 所以其状态并不会丢失.</li></ol><p><img src="/FE-Origincode/assets/update-fiber-memoizedstate-a2049ae8.png" alt=""></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本节首先引入了官方文档上对于<code>Hook</code>的解释, 了解<code>Hook</code>的由来, 以及<code>Hook</code>相较于<code>class</code>的优势. 然后从<code>fiber</code>视角分析了<code>fiber</code>与<code>hook</code>的内在关系, 通过<code>renderWithHooks</code>函数, 把<code>Hook</code>链表挂载到了<code>fiber.memoizedState</code>之上. 利用<code>fiber树</code>内部的双缓冲技术, 实现了<code>Hook</code>从<code>current</code>到<code>workInProgress</code>转移, 进而实现了<code>Hook</code>状态的持久化.</p></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:inherit;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Last Updated 2023-06-11 02:34:02<!--]--></span></span></div></footer><nav class="page-nav"><p class="hasPrev hasNext inner"><span class="page-nav-item prev"> ← 状态与副作用</span><span class="page-nav-item next">Hook 原理(状态Hook) → </span></p></nav><!----></main><!--]--><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#hook-与-fiber" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Hook 与 Fiber"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 与 Fiber<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#hook-数据结构" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Hook 数据结构"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 数据结构<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#hook-分类" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Hook 分类"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hook 分类<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#状态-hook" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="状态 Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->状态 Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#副作用-hook" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="副作用 Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->副作用 Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#组合-hook" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="组合 Hook"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->组合 Hook<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#调用-function-前" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="调用 function 前"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->调用 function 前<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#处理函数" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="处理函数"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->处理函数<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#全局变量" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="全局变量"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->全局变量<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#renderwithhooks-函数" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="renderWithHooks 函数"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->renderWithHooks 函数<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#调用-function" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="调用 function"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->调用 function<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#hooks-构造" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="Hooks 构造"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->Hooks 构造<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#链表存储" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="链表存储"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->链表存储<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#顺序克隆" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="顺序克隆"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->顺序克隆<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/FE-Origincode/docs/react/principle-analysis/hook-summary.html#总结" class="router-link-active router-link-exact-active link page-catalog-item" aria-label="总结"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:inherit;font-size:14px;"><!--[-->总结<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--></ul></div></div></div></div><!----><!----><!--]--></div>
    <script type="module" src="/FE-Origincode/assets/app-f2c4a527.js" defer></script>
  </body>
</html>
