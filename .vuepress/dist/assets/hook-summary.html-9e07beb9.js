import{_ as l,p as r,q as i,s,R as n,t as a,a2 as p,Y as o,n as c}from"./framework-e1bed10d.js";const u="/FE-Origincode/assets/hook-linkedlist-bc498055.png",d="/FE-Origincode/assets/mount-before-renderwithhooks-6d3a2d2a.png",k="/FE-Origincode/assets/mount-after-renderwithhooks-0f3f0adb.png",v="/FE-Origincode/assets/mount-fiber-memoizedstate-2bfedd30.png",m="/FE-Origincode/assets/update-before-renderwithhooks-0aae8e90.png",b="/FE-Origincode/assets/update-after-renderwithhooks-4735481a.png",h="/FE-Origincode/assets/update-fiber-memoizedstate-a2049ae8.png",f={},g=s("h1",{id:"hook-原理-概览",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#hook-原理-概览","aria-hidden":"true"},"#"),n(" Hook 原理(概览)")],-1),y=s("code",null,"class组件, function组件",-1),_=s("code",null,"api",-1),H=s("code",null,"fiber节点",-1),w=s("code",null,"状态",-1),S=s("code",null,"副作用",-1),x=s("code",null,"function组件",-1),I=s("code",null,"Hook",-1),P={href:"https://zh-hans.reactjs.org/docs/hooks-intro.html",target:"_blank",rel:"noopener noreferrer"},F=s("code",null,"FAQ",-1),E={href:"https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation",target:"_blank",rel:"noopener noreferrer"},R=s("code",null,"Hook",-1),j=s("ul",null,[s("li",null,[n("在组件之间复用状态逻辑很难; 复杂组件变得难以理解; 难以理解的 class. 为了解决这些实际开发痛点, 引入了"),s("code",null,"Hook"),n(".")])],-1),L={href:"https://zh-hans.reactjs.org/docs/hooks-state.html#whats-a-hook",target:"_blank",rel:"noopener noreferrer"},C=s("code",null,"Hook",-1),z=s("code",null,"Hook",-1),W=o("<ul><li><code>Hook</code> 是一个特殊的函数, 它可以让你“钩入” <code>React</code> 的特性. 如, <code>useState</code> 是允许你在 <code>React</code> 函数组件中添加 <code>state</code> 的 <code>Hook</code>.</li><li>如果你在编写函数组件并意识到需要向其添加一些 <code>state</code>, 以前的做法是必须将其转化为 <code>class</code>. 现在你可以在现有的函数组件中使用 <code>Hook</code>.</li></ul>",1),A={href:"https://zh-hans.reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render",target:"_blank",rel:"noopener noreferrer"},O=s("code",null,"Hook",-1),D=o("<ul><li>不会. 在现代浏览器中,闭包和类的原始性能只有在极端场景下才会有明显的差别. 除此之外,可以认为 <code>Hook</code> 的设计在某些方面更加高效: <ul><li><code>Hook</code> 避免了 <code>class</code> 需要的额外开支,像是创建类实例和在构造函数中绑定事件处理器的成本.</li><li>符合语言习惯的代码在使用 <code>Hook</code> 时不需要很深的组件树嵌套. 这个现象在使用<code>高阶组件</code>、<code>render props</code>、和 <code>context</code> 的代码库中非常普遍. 组件树小了, <code>React</code> 的工作量也随之减少.</li></ul></li></ul>",1),Q=s("p",null,[n("所以"),s("code",null,"Hook"),n("是"),s("code",null,"React"),n("团队在大量实践后的产物, 更优雅的代替"),s("code",null,"class"),n(", 且性能更高. 故从开发使用者的角度来讲, 应该拥抱"),s("code",null,"Hook"),n("所带来的便利.")],-1),U=s("h2",{id:"hook-与-fiber",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#hook-与-fiber","aria-hidden":"true"},"#"),n(" Hook 与 Fiber")],-1),q=s("code",null,"Hook",-1),B=s("code",null,"Hook",-1),T=s("code",null,"fiber节点",-1),N=s("code",null,"状态",-1),V=s("code",null,"副作用",-1),M=s("code",null,"fiber",-1),Y=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 1. fiber节点自身状态相关</span>
  <span class="token literal-property property">pendingProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 2. fiber节点副作用(Effect)相关</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> Flags<span class="token punctuation">,</span>
  <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">firstEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastEffect</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用<code>Hook</code>的任意一个<code>api</code>, 最后都是为了控制上述这几个<code>fiber属性</code>.</p><h2 id="hook-数据结构" tabindex="-1"><a class="header-anchor" href="#hook-数据结构" aria-hidden="true">#</a> Hook 数据结构</h2>`,3),G={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L95-L140",target:"_blank",rel:"noopener noreferrer"},J=s("code",null,"Hook",-1),K=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>type Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">lane</span><span class="token operator">:</span> Lane<span class="token punctuation">,</span>
  <span class="token literal-property property">action</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eagerReducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eagerState</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">next</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  priority<span class="token operator">?</span><span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

type UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">pending</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> mixed<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastRenderedReducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastRenderedState</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> type Hook <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 当前状态</span>
  <span class="token literal-property property">baseState</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token comment">// 基状态</span>
  <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> Update<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 基队列</span>
  <span class="token literal-property property">queue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 更新队列</span>
  <span class="token literal-property property">next</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// next指针</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从定义来看, <code>Hook</code>对象共有 5 个属性(有关这些属性的应用, 将在<code>Hook 原理(状态)</code>章节中具体分析.):</p><ol><li><code>hook.memoizedState</code>: 保持在内存中的局部状态.</li><li><code>hook.baseState</code>: <code>hook.baseQueue</code>中所有<code>update</code>对象合并之后的状态.</li><li><code>hook.baseQueue</code>: 存储<code>update对象</code>的环形链表, 只包括高于本次渲染优先级的<code>update对象</code>.</li><li><code>hook.queue</code>: 存储<code>update对象</code>的环形链表, 包括所有优先级的<code>update对象</code>.</li><li><code>hook.next</code>: <code>next</code>指针, 指向链表中的下一个<code>hook</code>.</li></ol><p>所以<code>Hook</code>是一个链表, 单个<code>Hook</code>拥有自己的状态<code>hook.memoizedState</code>和自己的更新队列<code>hook.queue</code>(有关 Hook 状态的分析, 在<code>Hook原理(状态)</code>章节中解读).</p><p><img src="`+u+'" alt=""></p><p>注意: 其中<code>hook.queue</code>与<code>fiber.updateQueue</code>虽然都是<code>update环形链表</code>, 尽管<code>update对象</code>的数据结构与处理方式都高度相似, 但是这 2 个队列中的<code>update对象</code>是完全独立的. <code>hook.queue</code>只作用于<code>hook对象</code>的状态维护, 切勿与<code>fiber.updateQueue</code>混淆.</p><h2 id="hook-分类" tabindex="-1"><a class="header-anchor" href="#hook-分类" aria-hidden="true">#</a> Hook 分类</h2>',7),X=s("code",null,"v17.0.2",-1),Z={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125",target:"_blank",rel:"noopener noreferrer"},$=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> type HookType <span class="token operator">=</span>
  <span class="token operator">|</span> <span class="token string">&#39;useState&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useReducer&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useContext&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useRef&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useEffect&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useLayoutEffect&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useCallback&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useMemo&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useImperativeHandle&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useDebugValue&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useDeferredValue&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useTransition&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useMutableSource&#39;</span>
  <span class="token operator">|</span> <span class="token string">&#39;useOpaqueIdentifier&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>官网上已经将其分为了 2 个类别, 状态<code>Hook</code>(<code>State Hook</code>), 和副作用<code>Hook</code>(<code>Effect Hook</code>).</p>`,2),nn=s("code",null,"fiber",-1),sn=s("code",null,"状态Hook",-1),an=s("code",null,"副作用Hook",-1),en=o('<h3 id="状态-hook" tabindex="-1"><a class="header-anchor" href="#状态-hook" aria-hidden="true">#</a> 状态 Hook</h3><p>狭义上讲, <code>useState, useReducer</code>可以在<code>function组件</code>添加内部的<code>state</code>, 且<code>useState</code>实际上是<code>useReducer</code>的简易封装, 是一个最特殊(简单)的<code>useReducer</code>. 所以将<code>useState, useReducer</code>称为<code>状态Hook</code>.</p><p>广义上讲, 只要能实现数据持久化<code>且没有副作用</code>的<code>Hook</code>, 均可以视为<code>状态Hook</code>, 所以还包括<code>useContext, useRef, useCallback, useMemo</code>等. 这类<code>Hook</code>内部没有使用<code>useState/useReducer</code>, 但是它们也能实现多次<code>render</code>时, 保持其初始值不变(即数据持久化)且没有任何<code>副作用</code>.</p>',3),on=s("code",null,"render",-1),tn=s("code",null,"fiber",-1),pn=s("code",null,"Hook",-1),cn=s("code",null,"Hook原理(状态)",-1),ln=o(`<h3 id="副作用-hook" tabindex="-1"><a class="header-anchor" href="#副作用-hook" aria-hidden="true">#</a> 副作用 Hook</h3><p>回到<code>fiber</code>视角, <code>状态Hook</code>实现了状态持久化(等同于<code>class组件</code>维护<code>fiber.memoizedState</code>), 那么<code>副作用Hook</code>则会修改<code>fiber.flags</code>. (通过前文<code>fiber树构造</code>系列的解读, 我们知道在<code>performUnitOfWork-&gt;completeWork</code>阶段, 所有存在副作用的<code>fiber</code>节点, 都会被添加到父节点的<code>副作用队列</code>后, 最后在<code>commitRoot</code>阶段处理这些<code>副作用节点</code>.)</p><p>另外, <code>副作用Hook</code>还提供了<code>副作用回调</code>(类似于<code>class组件</code>的生命周期回调), 比如:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 使用useEffect时, 需要传入一个副作用回调函数.</span>
<span class="token comment">// 在fiber树构造完成之后, commitRoot阶段会处理这些副作用回调</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;这是一个副作用回调函数&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>react</code>内部, <code>useEffect</code>就是最标准的<code>副作用Hook</code>. 其他比如<code>useLayoutEffect</code>以及<code>自定义Hook</code>, 如果要实现<code>副作用</code>, 必须直接或间接的调用<code>useEffect</code>.</p><p>有关<code>useEffect</code>具体实现细节, 在<code>Hook原理(副作用)</code>章节中讨论.</p><h3 id="组合-hook" tabindex="-1"><a class="header-anchor" href="#组合-hook" aria-hidden="true">#</a> 组合 Hook</h3><p>虽然官网并无<code>组合Hook</code>的说法, 但事实上大多数<code>Hook</code>(包括自定义<code>Hook</code>)都是由上述 2 种 <code>Hook</code>组合而成, 同时拥有这 2 种 Hook 的特性.</p><ul><li>在<code>react</code>内部有<code>useDeferredValue, useTransition, useMutableSource, useOpaqueIdentifier</code>等.</li><li>平时开发中, <code>自定义Hook</code>大部分都是组合 Hook.</li></ul>`,9),rn={href:"https://zh-hans.reactjs.org/docs/hooks-custom.html#extracting-a-custom-hook",target:"_blank",rel:"noopener noreferrer"},un=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useFriendStatus</span><span class="token punctuation">(</span><span class="token parameter">friendID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 调用useState, 创建一个状态Hook</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOnline<span class="token punctuation">,</span> setIsOnline<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 调用useEffect, 创建一个副作用Hook</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setIsOnline</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>isOnline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ChatAPI<span class="token punctuation">.</span><span class="token function">subscribeToFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ChatAPI<span class="token punctuation">.</span><span class="token function">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span>friendID<span class="token punctuation">,</span> handleStatusChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="调用-function-前" tabindex="-1"><a class="header-anchor" href="#调用-function-前" aria-hidden="true">#</a> 调用 function 前</h2><p>在调用<code>function</code>之前, <code>react</code>内部还需要提前做一些准备工作.</p><h3 id="处理函数" tabindex="-1"><a class="header-anchor" href="#处理函数" aria-hidden="true">#</a> 处理函数</h3>`,4),dn=s("code",null,"fiber树构造",-1),kn=s("code",null,"fiber",-1),vn=s("code",null,"处理函数",-1),mn=s("code",null,"fiber子节点",-1),bn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3340-L3354",target:"_blank",rel:"noopener noreferrer"},hn=s("code",null,"处理函数",-1),fn=s("code",null,"处理函数",-1),gn=s("code",null,"updateFunctionComponent",-1),yn=s("code",null,"Hook对象",-1),_n=s("code",null,"updateClassComponent",-1),Hn=s("code",null,"class实例",-1),wn=s("code",null,"Hook",-1),Sn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L702-L783",target:"_blank",rel:"noopener noreferrer"},xn=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 只保留FunctionComponent相关:</span>
<span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateLanes <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lanes<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> Component <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token keyword">const</span> unresolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolvedProps <span class="token operator">=</span>
        workInProgress<span class="token punctuation">.</span>elementType <span class="token operator">===</span> Component
          <span class="token operator">?</span> unresolvedProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>Component<span class="token punctuation">,</span> unresolvedProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span>
        workInProgress<span class="token punctuation">,</span>
        Component<span class="token punctuation">,</span>
        resolvedProps<span class="token punctuation">,</span>
        renderLanes<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
  <span class="token parameter">current<span class="token punctuation">,</span>
  workInProgress<span class="token punctuation">,</span>
  Component<span class="token punctuation">,</span>
  <span class="token literal-property property">nextProps</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  renderLanes<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...省略无关代码</span>
  <span class="token keyword">let</span> context<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextChildren<span class="token punctuation">;</span>
  <span class="token function">prepareToReadContext</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 进入Hooks相关逻辑, 最后返回下级ReactElement对象</span>
  nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    workInProgress<span class="token punctuation">,</span>
    Component<span class="token punctuation">,</span>
    nextProps<span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    renderLanes<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 进入reconcile函数, 生成下级fiber节点</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">,</span> renderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回下级fiber节点</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),In=s("code",null,"updateFunctionComponent",-1),Pn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476",target:"_blank",rel:"noopener noreferrer"},Fn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js",target:"_blank",rel:"noopener noreferrer"},En=s("code",null,"Fiber",-1),Rn=s("code",null,"Hook",-1),jn=s("h3",{id:"全局变量",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#全局变量","aria-hidden":"true"},"#"),n(" 全局变量")],-1),Ln=s("code",null,"renderWithHooks",-1),Cn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js",target:"_blank",rel:"noopener noreferrer"},zn=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 渲染优先级</span>
<span class="token keyword">let</span> <span class="token literal-property property">renderLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token comment">// 当前正在构造的fiber, 等同于 workInProgress, 为了和当前hook区分, 所以将其改名</span>
<span class="token keyword">let</span> <span class="token literal-property property">currentlyRenderingFiber</span><span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Hooks被存储在fiber.memoizedState 链表上</span>
<span class="token keyword">let</span> <span class="token literal-property property">currentHook</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// currentHook = fiber(current).memoizedState</span>

<span class="token keyword">let</span> <span class="token literal-property property">workInProgressHook</span><span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// workInProgressHook = fiber(workInProgress).memoizedState</span>

<span class="token comment">// 在function的执行过程中, 是否再次发起了更新. 只有function被完全执行之后才会重置.</span>
<span class="token comment">// 当render异常时, 通过该变量可以决定是否清除render过程中的更新.</span>
<span class="token keyword">let</span> <span class="token literal-property property">didScheduleRenderPhaseUpdate</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 在本次function的执行过程中, 是否再次发起了更新. 每一次调用function都会被重置</span>
<span class="token keyword">let</span> <span class="token literal-property property">didScheduleRenderPhaseUpdateDuringThisPass</span><span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 在本次function的执行过程中, 重新发起更新的最大次数</span>
<span class="token keyword">const</span> <span class="token constant">RE_RENDER_LIMIT</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个变量的解释, 可以对照源码中的英文注释, 其中最重要的有:</p><ol><li><code>currentlyRenderingFiber</code>: 当前正在构造的 fiber, 等同于 workInProgress</li><li><code>currentHook 与 workInProgressHook</code>: 分别指向<code>current.memoizedState</code>和<code>workInProgress.memoizedState</code></li></ol>`,3),Wn=s("code",null,"current",-1),An=s("code",null,"workInProgress",-1),On=s("h3",{id:"renderwithhooks-函数",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#renderwithhooks-函数","aria-hidden":"true"},"#"),n(" renderWithHooks 函数")],-1),Dn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476",target:"_blank",rel:"noopener noreferrer"},Qn=s("code",null,"function",-1),Un=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ...省略无关代码</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> renderWithHooks<span class="token operator">&lt;</span>Props<span class="token punctuation">,</span> SecondArg<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">workInProgress</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token function-variable function">Component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">p</span><span class="token operator">:</span> Props<span class="token punctuation">,</span> <span class="token literal-property property">arg</span><span class="token operator">:</span> SecondArg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any<span class="token punctuation">,</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> Props<span class="token punctuation">,</span>
  <span class="token literal-property property">secondArg</span><span class="token operator">:</span> SecondArg<span class="token punctuation">,</span>
  <span class="token literal-property property">nextRenderLanes</span><span class="token operator">:</span> Lanes<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token comment">// --------------- 1. 设置全局变量 -------------------</span>
  renderLanes <span class="token operator">=</span> nextRenderLanes<span class="token punctuation">;</span> <span class="token comment">// 当前渲染优先级</span>
  currentlyRenderingFiber <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span> <span class="token comment">// 当前fiber节点, 也就是function组件对应的fiber节点</span>

  <span class="token comment">// 清除当前fiber的遗留状态</span>
  workInProgress<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token comment">// --------------- 2. 调用function,生成子级ReactElement对象 -------------------</span>
  <span class="token comment">// 指定dispatcher, 区分mount和update</span>
  ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span>
    current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>memoizedState <span class="token operator">===</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> HooksDispatcherOnMount
      <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span>
  <span class="token comment">// 执行function函数, 其中进行分析Hooks的使用</span>
  <span class="token keyword">let</span> children <span class="token operator">=</span> <span class="token function">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> secondArg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --------------- 3. 重置全局变量,并返回 -------------------</span>
  <span class="token comment">// 执行function之后, 还原被修改的全局变量, 不影响下一次调用</span>
  renderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  currentlyRenderingFiber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>

  currentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  didScheduleRenderPhaseUpdate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> children<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>调用<code>function</code>前: 设置全局变量, 标记<code>渲染优先级</code>和当前<code>fiber</code>, 清除当前<code>fiber</code>的遗留状态.</li><li>调用<code>function</code>: 构造出<code>Hooks</code>链表, 最后生成子级<code>ReactElement</code>对象(<code>children</code>).</li><li>调用<code>function</code>后: 重置全局变量, 返回<code>children</code>. <ul><li>为了保证不同的<code>function</code>节点在调用时<code>renderWithHooks</code>互不影响, 所以退出时重置全局变量.</li></ul></li></ol><h2 id="调用-function" tabindex="-1"><a class="header-anchor" href="#调用-function" aria-hidden="true">#</a> 调用 function</h2><h3 id="hooks-构造" tabindex="-1"><a class="header-anchor" href="#hooks-构造" aria-hidden="true">#</a> Hooks 构造</h3><p>在<code>function</code>中, 如果使用了<code>Hook api</code>(如: <code>useEffect</code>, <code>useState</code>), 就会创建一个与之对应的<code>Hook</code>对象, 接下来重点分析这个创建过程.</p>`,5),qn={href:"https://codesandbox.io/s/hook-summary-wb7zz?fontsize=14&hidenavigation=1&theme=dark",target:"_blank",rel:"noopener noreferrer"},Bn=s("img",{src:"https://codesandbox.io/static/img/play-codesandbox.svg",alt:"Edit hook-summary"},null,-1),Tn=o(`<div class="language-jsx line-numbers-mode" data-ext="jsx"><pre class="language-jsx"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. useState</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> setA<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. useEffect</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">effect 1 created</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. useState</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 4. useEffect</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">effect 2 created</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setA</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>a<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>b<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>function</code>组件中, 同时使用了<code>状态Hook</code>和<code>副作用Hook</code>.</p><p>初次渲染时, 逻辑执行到<code>performUnitOfWork-&gt;beginWork-&gt;updateFunctionComponent-&gt;renderWithHooks</code>前, 内存结构如下(本节重点是<code>Hook</code>, 有关<code>fiber树构造</code>过程可回顾前文):</p><p><img src="`+d+'" alt=""></p><p>当执行<code>renderWithHooks</code>时, 开始调用<code>function</code>. 本例中, 在<code>function</code>内部, 共使用了 4 次<code>Hook api</code>, 依次调用<code>useState, useEffect, useState, useEffect</code>.</p>',5),Nn=s("code",null,"useState, useEffect",-1),Vn=s("code",null,"fiber",-1),Mn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1113-L1136",target:"_blank",rel:"noopener noreferrer"},Yn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1193-L1248",target:"_blank",rel:"noopener noreferrer"},Gn=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> mountState<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">initialState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span>BasicStateAction<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags<span class="token punctuation">,</span> hookFlags<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>无论<code>useState, useEffect</code>, 内部都通过<code>mountWorkInProgressHook</code>创建一个 hook.</p><h3 id="链表存储" tabindex="-1"><a class="header-anchor" href="#链表存储" aria-hidden="true">#</a> 链表存储</h3>`,3),Jn={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L531-L550",target:"_blank",rel:"noopener noreferrer"},Kn=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">hook</span><span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token literal-property property">baseState</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token literal-property property">queue</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 链表中首个hook</span>
    currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将hook添加到链表末尾</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑是创建<code>Hook</code>并挂载到<code>fiber.memoizedState</code>上, 多个<code>Hook</code>以链表结构保存.</p><p>本示例中, <code>function</code>调用之后则会创建 4 个<code>hook</code>, 这时的内存结构如下:</p><p><img src="`+k+'" alt=""></p><p>可以看到: 无论<code>状态Hook</code>或<code>副作用Hook</code>都按照调用顺序存储在<code>fiber.memoizedState</code>链表中.</p><p><img src="'+v+'" alt=""></p><h3 id="顺序克隆" tabindex="-1"><a class="header-anchor" href="#顺序克隆" aria-hidden="true">#</a> 顺序克隆</h3><p><code>fiber树构造(对比更新)</code>阶段, 执行<code>updateFunctionComponent-&gt;renderWithHooks</code>时再次调用<code>function</code>, <code>调用function前</code>的内存结构如下:</p><p><img src="'+m+'" alt=""></p><p>注意: 在<code>renderWithHooks</code>函数中已经设置了<code>workInProgress.memoizedState = null</code>, 等待调用<code>function</code>时重新设置.</p>',10),Xn=s("code",null,"function",-1),Zn=s("code",null,"useState, useEffect, useState, useEffect",-1),$n=s("code",null,"useState, useEffect",-1),ns=s("code",null,"fiber",-1),ss={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1138-L1142",target:"_blank",rel:"noopener noreferrer"},as={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1205-L1266",target:"_blank",rel:"noopener noreferrer"},es=o(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// ----- 状态Hook --------</span>
<span class="token keyword">function</span> updateReducer<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">I</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
  <span class="token literal-property property">initialArg</span><span class="token operator">:</span> <span class="token constant">I</span><span class="token punctuation">,</span>
  init<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">I</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span> Dispatch<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>

<span class="token comment">// ----- 副作用Hook --------</span>
<span class="token keyword">function</span> <span class="token function">updateEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags<span class="token punctuation">,</span> hookFlags<span class="token punctuation">,</span> create<span class="token punctuation">,</span> deps</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...省略部分本节不讨论</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>无论<code>useState, useEffect</code>, 内部调用<code>updateWorkInProgressHook</code>获取一个 hook.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token comment">// 1. 移动currentHook指针</span>
  <span class="token keyword">let</span> <span class="token literal-property property">nextCurrentHook</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      nextCurrentHook <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nextCurrentHook <span class="token operator">=</span> currentHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. 移动workInProgressHook指针</span>
  <span class="token keyword">let</span> <span class="token literal-property property">nextWorkInProgressHook</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Hook<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextWorkInProgressHook <span class="token operator">=</span> currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextWorkInProgressHook <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 渲染时更新: 本节不讨论</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>
    <span class="token comment">// 3. 克隆currentHook作为新的workInProgressHook.</span>
    <span class="token comment">// 随后逻辑与mountWorkInProgressHook一致</span>
    <span class="token keyword">const</span> <span class="token literal-property property">newHook</span><span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">memoizedState</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>

      <span class="token literal-property property">baseState</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>
      <span class="token literal-property property">baseQueue</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseQueue<span class="token punctuation">,</span>
      <span class="token literal-property property">queue</span><span class="token operator">:</span> currentHook<span class="token punctuation">.</span>queue<span class="token punctuation">,</span>

      <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 注意next指针是null</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentlyRenderingFiber<span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>updateWorkInProgressHook</code>函数逻辑简单: 目的是为了让<code>currentHook</code>和<code>workInProgressHook</code>两个指针同时向后移动.</p><ol><li>由于<code>renderWithHooks函数</code>设置了<code>workInProgress.memoizedState=null</code>, 所以<code>workInProgressHook</code>初始值必然为<code>null</code>, 只能从<code>currentHook</code>克隆.</li><li>而从<code>currentHook</code>克隆而来的<code>newHook.next=null</code>, 进而导致<code>workInProgressHook</code>链表需要完全重建.</li></ol><p>所以<code>function</code>执行完成之后, 有关<code>Hook</code>的内存结构如下:</p><p><img src="`+b+'" alt=""></p><p>可以看到:</p><ol><li>以双缓冲技术为基础, 将<code>current.memoizedState</code>按照顺序克隆到了<code>workInProgress.memoizedState</code>中.</li><li><code>Hook</code>经过了一次克隆, 内部的属性(<code>hook.memoizedState</code>等)都没有变动, 所以其状态并不会丢失.</li></ol><p><img src="'+h+'" alt=""></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本节首先引入了官方文档上对于<code>Hook</code>的解释, 了解<code>Hook</code>的由来, 以及<code>Hook</code>相较于<code>class</code>的优势. 然后从<code>fiber</code>视角分析了<code>fiber</code>与<code>hook</code>的内在关系, 通过<code>renderWithHooks</code>函数, 把<code>Hook</code>链表挂载到了<code>fiber.memoizedState</code>之上. 利用<code>fiber树</code>内部的双缓冲技术, 实现了<code>Hook</code>从<code>current</code>到<code>workInProgress</code>转移, 进而实现了<code>Hook</code>状态的持久化.</p>',12);function os(ts,ps){const t=c("RouterLink"),e=c("ExternalLinkIcon");return r(),i("div",null,[g,s("p",null,[n("在前文"),a(t,{to:"/docs/react/principle-analysis/state-effects.html"},{default:p(()=>[n("状态与副作用")]),_:1}),n("中, 总结了"),y,n("中通过"),_,n("去改变"),H,n("的"),w,n("和"),S,n(". 其中对于"),x,n("来讲, 其内部则需要依靠"),I,n("来实现.")]),s("p",null,[n("官方文档上专门用了一个版块来介绍"),s("a",P,[n("Hook"),a(e)]),n(", 这里摘抄了几个比较关心的问题(其他"),F,n("请移步官网):")]),s("ol",null,[s("li",null,[s("p",null,[s("a",E,[n("引入"),R,n("的动机?"),a(e)])]),j]),s("li",null,[s("p",null,[s("a",L,[C,n(" 是什么? 什么时候会用 "),z,n("?"),a(e)])]),W]),s("li",null,[s("p",null,[s("a",A,[O,n(" 会因为在渲染时创建函数而变慢吗?"),a(e)])]),D])]),Q,U,s("p",null,[n("通过官网文档的讲解, 能快速掌握"),q,n("的使用. 再结合前文"),a(t,{to:"/docs/react/principle-analysis/state-effects.html"},{default:p(()=>[n("状态与副作用")]),_:1}),n("的介绍, 我们知道使用"),B,n("最终也是为了控制"),T,n("的"),N,n("和"),V,n(". 从"),M,n("视角, 状态和副作用相关的属性如下(这里不再解释单个属性的意义, 可以回顾"),a(t,{to:"/docs/react/principle-analysis/state-effects.html"},{default:p(()=>[n("状态与副作用")]),_:1}),n("):")]),Y,s("p",null,[n("在"),s("a",G,[n("ReactFiberHooks"),a(e)]),n("中, 定义了"),J,n("的数据结构:")]),K,s("p",null,[n("在"),X,n("中, 共定义了"),s("a",Z,[n("14 种 Hook"),a(e)])]),$,s("p",null,[n("这里我们可以结合前文"),a(t,{to:"/docs/react/principle-analysis/state-effects.html"},{default:p(()=>[n("状态与副作用")]),_:1}),n(", 从"),nn,n("的视角去理解"),sn,n("与"),an,n("的区别.")]),en,s("p",null,[n("得益于"),a(t,{to:"/docs/react/principle-analysis/fibertree-prepare.html#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF"},{default:p(()=>[n("双缓冲技术(double buffering)")]),_:1}),n(", 在多次"),on,n("时, 以"),tn,n("为载体, 保证复用同一个"),pn,n("对象, 进而实现数据持久化. 具体实现细节, 在"),cn,n("章节中讨论.")]),ln,s("p",null,[n("比如官网上的"),s("a",rn,[n("自定义 Hook"),a(e)]),n("例子:")]),un,s("p",null,[n("从"),dn,n("的视角来看, 不同的"),kn,n("类型, 只需要调用不同的"),vn,n("返回"),mn,n(". 所以在"),s("a",bn,[n("performUnitOfWork->beginWork"),a(e)]),n("函数中, 调用了多种"),hn,n(". 从调用方来讲, 无需关心"),fn,n("的内部实现(比如"),gn,n("内部使用了"),yn,n(", "),_n,n("内部使用了"),Hn,n(").")]),s("p",null,[n("本节讨论"),wn,n(", 所以列出其中的"),s("a",Sn,[n("updateFunctionComponent"),a(e)]),n("函数:")]),xn,s("p",null,[n("在"),In,n("函数中调用了"),s("a",Pn,[n("renderWithHooks"),a(e)]),n("(位于"),s("a",Fn,[n("ReactFiberHooks"),a(e)]),n(") , 至此"),En,n("与"),Rn,n("产生了关联.")]),jn,s("p",null,[n("在分析"),Ln,n("函数前, 有必要理解"),s("a",Cn,[n("ReactFiberHooks"),a(e)]),n("头部定义的全局变量(源码中均有英文注释):")]),zn,s("p",null,[n("注: 有关"),Wn,n("和"),An,n("的区别, 请回顾"),a(t,{to:"/docs/react/principle-analysis/fibertree-prepare.html#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF"},{default:p(()=>[n("双缓冲技术(double buffering)")]),_:1})]),On,s("p",null,[s("a",Dn,[n("renderWithHooks"),a(e)]),n("源码看似较长, 但是去除 dev 后保留主干, 逻辑十分清晰. 以调用"),Qn,n("为分界点, 逻辑被分为 3 个部分:")]),Un,s("p",null,[n("有如下 demo: "),s("a",qn,[Bn,a(e)])]),Tn,s("p",null,[n("而"),Nn,n("在"),Vn,n("初次构造时分别对应"),s("a",Mn,[n("mountState"),a(e)]),n("和"),s("a",Yn,[n("mountEffect->mountEffectImpl"),a(e)])]),Gn,s("p",null,[n("而"),s("a",Jn,[n("mountWorkInProgressHook"),a(e)]),n("非常简单:")]),Kn,s("p",null,[n("接下来调用"),Xn,n(", 同样依次调用"),Zn,n(". 而"),$n,n("在"),ns,n("对比更新时分别对应"),s("a",ss,[n("updateState->updateReducer"),a(e)]),n("和"),s("a",as,[n("updateEffect->updateEffectImpl"),a(e)])]),es])}const ls=l(f,[["render",os],["__file","hook-summary.html.vue"]]);export{ls as default};
